"use strict";var Dep=function(){this.subs=[]};Dep.prototype.addSub=function(t){this.subs.push(t)},Dep.prototype.notify=function(){for(var t=0;t<this.subs.length;t++)this.subs[t].update()};var Watcher=function(t,e,i){this.view=t,this.exp=e,this.cb=i,Dep.target=this,this.val=this.get()};Watcher.prototype.get=function(){var t=this.view[this.exp];return Dep.target=null,t},Watcher.prototype.update=function(){var t=this.get(),e=this.val;t!==e&&(this.val=t,this.cb.call(this.vm,t,e))};var elementNode=function(t){return 1===t.nodeType},textNode=function(t){return 3===t.nodeType},html=function(t){if(t){var e=document.createElement("html");return e.innerHTML=t.trim(),e.children[1].firstChild}},Compile=function(t){this.view=t;var e=this.view.__proto__;e.beforeMount&&e.beforeMount(),this.view.components&&(this.components=this.view.components()),this.view.template&&(this.template=html(this.view.template())),this.walkNodes(this.template),this.nodes(this.template),e.mounted&&e.mounted()};Compile.prototype.nodes=function(t){for(var e=t.querySelectorAll("*"),i=0;i<e.length;i++)this.bindMethods(e[i].attributes)},Compile.prototype.bindMethods=function(t){var e=this;return Object.values(t).reduce(function(t,i){var n=i.nodeName,o=i.nodeValue,r=i.ownerElement;return/bind/.test(n)?e.bind(r,o,n):/@/.test(n)?e.on(r,o,n):/loop/.test(n)?e.loop(r,o,n):void 0},[])},Compile.prototype.walkNodes=function(t){if(t)for(var e=t.childNodes,i=0;i<e.length;i++){var n=e[i],o=/\{\{(.*)\}\}/,r=n.textContent;elementNode(n)?this.components&&this.components.hasOwnProperty(n.localName)&&new(0,this.components[n.localName])(n):textNode(n)&&o.test(r)&&this.compileText(n,o.exec(r)[1].trim()),n.childNodes&&0!==n.childNodes.length&&this.walkNodes(n)}},Compile.prototype.compileText=function(t,e){if(this.view.data){var i=this.view.data[e];t.textContent=i,new Watcher(this.view,e,function(e){t.textContent=e||""})}},Compile.prototype.on=function(t,e,i){var n=this,o=i.substr(1);t.addEventListener(o,function(){return n.view[e](event)})},Compile.prototype.loop=function(t,e,i){e.split("in")[0].replace(/\s/g,"");var n=e.split("in")[1].replace(/\s/g,""),o=this.view.data[n],r=t.parentNode,s=t.localName;r.removeChild(t);for(var a=0;a<o.length;a++){var p=o[a],l=document.createElement(s);l.textContent=p,r.appendChild(l)}},Compile.prototype.bind=function(t,e,i){var n=this;return t.addEventListener("input",function(){n.view.data[e]=t.value}),new Watcher(this.view,i,function(e){t.value=e}),t.value=this.view.data[e]};var observe=function(t){if(t&&"object"==typeof t)for(var e=Object.keys(t),i=0;i<e.length;i++){var n=e[i];defineReactive(t,n,t[n])}},defineReactive=function(t,e,i){var n=new Dep;observe(i),Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:function(){return Dep.target&&n.addSub(Dep.target),i},set:function(t){t!==i&&(i=t,n.notify())}})},Lily=function(t){this.el=t&&t instanceof HTMLElement?t:t=document.body,this.data&&(this.data=this.data()),this.reactive(),observe(this.data),this.template=new Compile(this).template,this.render()};Lily.prototype.render=function(){this.el.appendChild(this.template)},Lily.prototype.get=function(t){return this.data[t]},Lily.prototype.set=function(t,e){this.data[t]=e},Lily.prototype.reactive=function(){for(var t=this,e=Object.keys(this.data),i=0;i<e.length;i++)!function(i){var n=e[i];Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:function(){return this.data[n]},set:function(t){this.data[n]=t}})}(i)},Lily.prototype.config={silent:!1},module.exports=Lily;
