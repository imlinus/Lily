!function(t){function e(t){return tasksByHandle[nextHandle]=t,registerImmediate(nextHandle),nextHandle++}function n(t){delete tasksByHandle[t]}function i(t){if(currentlyRunningATask)setTimeout(i,0,t);else{const e=tasksByHandle[t];if(e){currentlyRunningATask=!0;try{e()}finally{n(t),currentlyRunningATask=!1}}}}if(!t.setImmediate){const s={};let o,c=1,a=!1;"[object process]"==={}.toString.call(t.process)?function(){o=(t=>{process.nextTick(()=>{i(t)})})}():function(){const e=`setImmediate$${Math.random()}$`,n=n=>{n.source===t&&"string"==typeof n.data&&0===n.data.indexOf(e)&&i(+n.data.slice(e.length))};t.addEventListener("message",n,!1),o=(n=>{t.postMessage(e+n,"*")})}(),t.setImmediate=e,t.clearImmediate=n}}("undefined"==typeof self?"undefined"==typeof global?window:global:self);const watchers=new WeakMap,dispatch=Symbol(),isWatching=Symbol(),timer=Symbol(),isArray=Symbol(),changes=Symbol(),API={watch(t){if("function"!=typeof t)throw`Sorry`;return watchers.has(this)||watchers.set(this,[]),watchers.get(this).push(t),this},unwatch(t){const e=watchers.get(this);if(e){if(t){const n=e.indexOf(t);~n&&e.splice(n,1)}else watchers.set(this,[]);return this}},json(){return Object.keys(this).reduce((t,e)=>{const n=this[e];t[e]=n&&n.json?n.json():n;return t},this[isArray]?[]:{})}},TRAPS={set(t,e,n){return t[e]!==n&&(n!==Object(n)||n[isWatching]?t[e]=n:t[e]=icaro(n),t[dispatch](e,n)),!0}},define=(t,e,n)=>{Object.defineProperty(t,e,{value:n,enumerable:!1,configurable:!1,writable:!1})},enhance=t=>{Object.assign(t,{[changes]:new Map,[timer]:null,[isWatching]:!0,[dispatch]:(e,n)=>{watchers.has(t)&&(clearImmediate(t[timer]),t[changes].set(e,n),t[timer]=setImmediate(()=>{watchers.get(t).forEach(e=>e(t[changes]));t[changes].clear()}))}});Object.keys(API).forEach(e=>{define(t,e,API[e].bind(t))});Array.isArray(t)&&(t[isArray]=!0,t.forEach((e,n)=>{t[n]=null;TRAPS.set(t,n,e)}));return t},observe=t=>new Proxy(enhance(t||{}),Object.create(TRAPS));var is={elementNode:t=>1===t.nodeType,textNode:t=>3===t.nodeType,obj:t=>null!=t&&"object"==typeof t,arr:t=>Array.isArray(t)};class Compiler{constructor(t){this.vm=t;const e=this.vm.__proto__;return e.beforeMount&&e.beforeMount(),this.vm.components&&(this.components=this.vm.components()),this.vm.template&&(this.template=this.html(this.vm.template())),this.walkNodes(this.template),this.nodes(this.template),e.mounted&&e.mounted(),this.template}html(t){if(t){const e=document.createElement("html");return e.innerHTML=t.trim(),e.children[1].firstChild}}nodes(t){const e=t.parentNode.querySelectorAll("*");for(let t=0;t<e.length;t++)this.checkAttrs(e[t].attributes)}checkAttrs(t){return Object.values(t).reduce((t,e)=>{const n=e.ownerElement;const i=e.nodeValue;const s=e.nodeName;if(/model/.test(s))return this.model(n,i,s);if(/@/.test(s))return this.on(n,i,s);if(/loop/.test(s))return this.loop(n,i,s)},[])}walkNodes(t){if(t){const e=t.childNodes;for(let t=0;t<e.length;t++){const n=e[t],i=/\{\{(.*)\}\}/,s=n.textContent;if(i.test(s)&&this.text(n,i.exec(s)[1].trim()),is.elementNode(n)&&this.components&&this.components.hasOwnProperty(n.localName)){const t=this.components[n.localName];new t(n)}n.childNodes&&0!==n.childNodes.length&&this.walkNodes(n)}}}text(t,e){const n=this.vm.data[e];t.textContent=n,this.vm.data.watch(n=>{t.textContent=n.get(e)})}on(t,e,n){const i=n.substr(1);t.addEventListener(i,()=>{this.vm[e]&&this.vm[e](event)})}model(t,e,n){return t.addEventListener("input",()=>{this.vm.data[e]=t.value}),t.value=this.vm.data[e]}loop(t,e,n){const i=e.split("in")[1].replace(/\s/g,""),s=this.vm.data[i],o=t.parentNode;o.removeChild(t);for(let e=0;e<s.length;e++){const n=s[e],i=document.createElement(t.localName);i.textContent=n,o.appendChild(i)}}}const compiler=t=>new Compiler(t);class Lily{constructor(t){this.el=t&&t instanceof HTMLElement?t:t=document.body,this.data=observe(this.data()),this.template=compiler(this),this.render(),console.log(this)}render(){"body"===this.el.localName?this.el.appendChild(this.template):this.el.parentNode.replaceChild(this.template,this.el)}static mount(t){return new t}}export default Lily;
