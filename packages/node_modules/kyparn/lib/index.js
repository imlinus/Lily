const portr = require('portr')
const path = require('path')
const http = require('http')
const fs = require('fs')
const config = require('./response.js')

class Kyparn {
	constructor (opts) {
		this.src = opts.src ? path.join(process.cwd(), opts.src) : process.cwd()
		this.main = opts.main || 'index.html'
		this.port = opts.port || 1337

    portr(this.port).then(port => this.server(port))
  }
  
  server (port) {
    http.createServer((req, resp) => {
      const path = config.path(this, req.url)

			fs.readFile(path, (err, data) => {
				if (!err) {
					resp.writeHead(200, config.head(path))
					resp.end(data, 'utf-8')
				} else {
					if (err.code === 'ENOENT') {
						resp.writeHead(404)
						resp.end()
					} else {
						resp.writeHead(500)
						resp.end()
					}
				}
			})
    }).listen(port)
    
    console.log(`running @ http://localhost:${port}`)
  }
}

module.exports = Kyparn
